<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Kebun Rakyat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
    .hamburger.active span:nth-child(2) { opacity: 0; }
    .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 via-white to-green-50 min-h-screen">

  <nav class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-md shadow-md">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16 sm:h-20">
        <a href="index.html" class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
          <div class="w-9 h-9 sm:w-11 sm:h-11 bg-gradient-to-br from-green-600 to-green-400 rounded-xl flex items-center justify-center text-lg sm:text-xl">üå±</div>
          <div class="hidden sm:flex flex-col leading-tight">
            <span class="font-bold text-lg sm:text-xl text-green-600" style="font-family: Georgia, serif;">Kebun Rakyat</span>
            <span class="text-[9px] text-green-600 font-semibold tracking-widest">PASARAN PETANI</span>
          </div>
        </a>
        <ul class="hidden lg:flex items-center gap-8">
          <li><a href="marketplace.html" class="text-gray-600 hover:text-green-600 font-medium">Marketplace</a></li>
        </ul>
        <div class="flex items-center gap-2">
          <a href="cart.html" class="inline-flex items-center px-4 py-2 border-2 border-gray-200 text-gray-600 font-semibold text-sm rounded-full hover:border-green-400 transition-all">‚Üê Cart</a>
          <button id="mobile-menu-btn" class="hamburger lg:hidden flex flex-col gap-1.5 p-2" onclick="toggleMenu()">
            <span class="block w-5 h-0.5 bg-gray-700 transition-all duration-300"></span>
            <span class="block w-5 h-0.5 bg-gray-700 transition-all duration-300"></span>
            <span class="block w-5 h-0.5 bg-gray-700 transition-all duration-300"></span>
          </button>
        </div>
      </div>
    </div>
    <div id="mobile-menu" class="hidden lg:hidden bg-gradient-to-br from-green-600 to-green-500 shadow-lg">
      <ul class="container mx-auto px-4 py-4 space-y-1">
        <li><a href="marketplace.html" class="block text-white font-semibold text-base py-3 px-3 rounded-lg hover:bg-white/10">Marketplace</a></li>
        <li><a href="cart.html" class="block text-white font-semibold text-base py-3 px-3 rounded-lg hover:bg-white/10">Back to Cart</a></li>
      </ul>
    </div>
  </nav>

  <div class="pt-16 sm:pt-20">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-10">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 sm:mb-8" style="font-family: Georgia, serif;">Checkout</h1>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
        <!-- Form -->
        <div class="lg:col-span-2 space-y-5 sm:space-y-6">

          <!-- Personal Info -->
          <div class="bg-white rounded-2xl shadow-md p-5 sm:p-6 lg:p-8">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-5">Personal Information</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-sm sm:text-base font-semibold text-gray-700 mb-2">Full Name *</label>
                <input type="text" id="fullName" placeholder="Your full name" required class="w-full px-4 py-3 sm:py-4 border-2 border-gray-200 rounded-xl text-base focus:border-green-500 focus:outline-none transition-colors">
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm sm:text-base font-semibold text-gray-700 mb-2">Phone Number *</label>
                  <input type="tel" id="phone" placeholder="01X-XXXXXXX" required class="w-full px-4 py-3 sm:py-4 border-2 border-gray-200 rounded-xl text-base focus:border-green-500 focus:outline-none transition-colors">
                </div>
                <div>
                  <label class="block text-sm sm:text-base font-semibold text-gray-700 mb-2">Email Address *</label>
                  <input type="email" id="email" placeholder="your@email.com" required class="w-full px-4 py-3 sm:py-4 border-2 border-gray-200 rounded-xl text-base focus:border-green-500 focus:outline-none transition-colors">
                </div>
              </div>
            </div>
          </div>

          <!-- Delivery Address -->
          <div class="bg-white rounded-2xl shadow-md p-5 sm:p-6 lg:p-8">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-5">Delivery Address</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-sm sm:text-base font-semibold text-gray-700 mb-2">Street Address *</label>
                <textarea id="street" rows="2" placeholder="No. xx, Jalan..." required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-base focus:border-green-500 focus:outline-none transition-colors resize-none"></textarea>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm sm:text-base font-semibold text-gray-700 mb-2">City *</label>
                  <input type="text" id="city" placeholder="City" required class="w-full px-4 py-3 sm:py-4 border-2 border-gray-200 rounded-xl text-base focus:border-green-500 focus:outline-none transition-colors">
                </div>
                <div>
                  <label class="block text-sm sm:text-base font-semibold text-gray-700 mb-2">State *</label>
                  <select id="state" required class="w-full px-4 py-3 sm:py-4 border-2 border-gray-200 rounded-xl text-base focus:border-green-500 focus:outline-none transition-colors bg-white">
                    <option value="">Select State</option>
                    <option>Johor</option><option>Kedah</option><option>Kelantan</option><option>Melaka</option>
                    <option>Negeri Sembilan</option><option>Pahang</option><option>Perak</option><option>Perlis</option>
                    <option>Pulau Pinang</option><option>Sabah</option><option>Sarawak</option><option>Selangor</option>
                    <option>Terengganu</option><option>Kuala Lumpur</option><option>Labuan</option><option>Putrajaya</option>
                  </select>
                </div>
              </div>
              <div class="w-full sm:w-1/2">
                <label class="block text-sm sm:text-base font-semibold text-gray-700 mb-2">Postcode *</label>
                <input type="text" id="postcode" placeholder="XXXXX" maxlength="5" required class="w-full px-4 py-3 sm:py-4 border-2 border-gray-200 rounded-xl text-base focus:border-green-500 focus:outline-none transition-colors">
              </div>
            </div>
          </div>

          <!-- Payment -->
          <div class="bg-white rounded-2xl shadow-md p-5 sm:p-6 lg:p-8">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-5">Payment Method</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-400 transition-all has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
                <input type="radio" name="payment" value="fpx" checked class="accent-green-600">
                <span class="text-sm sm:text-base font-semibold">üí≥ Online Banking (FPX)</span>
              </label>
              <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-400 transition-all has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
                <input type="radio" name="payment" value="card" class="accent-green-600">
                <span class="text-sm sm:text-base font-semibold">üí∞ Credit / Debit Card</span>
              </label>
              <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-400 transition-all has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
                <input type="radio" name="payment" value="ewallet" class="accent-green-600">
                <span class="text-sm sm:text-base font-semibold">üì± E-Wallet (TnG / GrabPay)</span>
              </label>
              <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-400 transition-all has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
                <input type="radio" name="payment" value="cod" class="accent-green-600">
                <span class="text-sm sm:text-base font-semibold">üíµ Cash on Delivery</span>
              </label>
            </div>
          </div>

          <!-- Notes -->
          <div class="bg-white rounded-2xl shadow-md p-5 sm:p-6 lg:p-8">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Additional Notes <span class="text-gray-400 font-normal text-sm">(Optional)</span></h2>
            <textarea id="notes" rows="3" placeholder="Special delivery instructions..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-base focus:border-green-500 focus:outline-none transition-colors resize-none"></textarea>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-2xl shadow-md p-5 sm:p-6 sticky top-24">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Order Summary</h2>
            <div id="orderItems" class="space-y-3 mb-4 max-h-56 overflow-y-auto"></div>
            <div class="border-t pt-4 space-y-2 text-sm sm:text-base">
              <div class="flex justify-between text-gray-600"><span>Subtotal</span><span id="subtotal">RM 0.00</span></div>
              <div class="flex justify-between text-gray-600"><span>Delivery</span><span id="delivery">RM 5.00</span></div>
              <div class="flex justify-between font-bold text-base sm:text-lg text-gray-800 pt-2 border-t"><span>Total</span><span class="text-green-600" id="total">RM 0.00</span></div>
            </div>
            <button onclick="placeOrder()" id="placeBtn" class="w-full mt-5 py-3 sm:py-4 bg-gradient-to-r from-green-600 to-green-500 text-white font-bold text-base sm:text-lg rounded-xl hover:shadow-lg active:scale-95 transition-all">Place Order</button>
            <p class="text-gray-400 text-xs text-center mt-3">No account needed to order</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const grouped = {};
    cart.forEach(i => { if (!grouped[i.id]) grouped[i.id] = { ...i, qty: 0 }; grouped[i.id].qty++; });
    const items = Object.values(grouped);
    const subtotal = items.reduce((s, i) => s + i.price * i.qty, 0);
    const delivery = subtotal >= 50 ? 0 : 5;

    document.getElementById('subtotal').textContent = `RM ${subtotal.toFixed(2)}`;
    document.getElementById('delivery').textContent = delivery === 0 ? 'FREE' : `RM ${delivery.toFixed(2)}`;
    document.getElementById('total').textContent = `RM ${(subtotal + delivery).toFixed(2)}`;
    document.getElementById('orderItems').innerHTML = items.map(i => `
      <div class="flex items-center gap-3">
        <span class="text-2xl">${i.emoji}</span>
        <div class="flex-1 text-sm"><div class="font-semibold text-gray-700">${i.name}</div><div class="text-gray-400">${i.qty} kg √ó RM ${i.price.toFixed(2)}</div></div>
        <span class="font-semibold text-green-600 text-sm">RM ${(i.qty * i.price).toFixed(2)}</span>
      </div>`).join('');

    window.placeOrder = async () => {
      const fields = ['fullName', 'phone', 'email', 'street', 'city', 'state', 'postcode'];
      for (const f of fields) {
        if (!document.getElementById(f).value.trim()) {
          alert('Please fill in all required fields'); return;
        }
      }
      const btn = document.getElementById('placeBtn');
      btn.disabled = true; btn.textContent = 'Placing order...';
      try {
        const order = {
          customerName: document.getElementById('fullName').value,
          customerPhone: document.getElementById('phone').value,
          customerEmail: document.getElementById('email').value,
          deliveryAddress: { street: document.getElementById('street').value, city: document.getElementById('city').value, state: document.getElementById('state').value, postcode: document.getElementById('postcode').value },
          items, subtotal, deliveryFee: delivery, total: subtotal + delivery,
          paymentMethod: document.querySelector('input[name="payment"]:checked')?.value || 'fpx',
          notes: document.getElementById('notes').value,
          status: 'pending',
          orderNumber: 'ORD' + Date.now(),
          createdAt: new Date()
        };
        const ref = await addDoc(collection(db, 'orders'), order);
        localStorage.removeItem('cart');
        window.location.href = `order-confirmation.html?id=${ref.id}`;
      } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false; btn.textContent = 'Place Order';
      }
    };
  </script>
  <script>
    function toggleMenu() {
      document.getElementById('mobile-menu').classList.toggle('hidden');
      document.getElementById('mobile-menu-btn').classList.toggle('active');
    }
  </script>
</body>
</html>