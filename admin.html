<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Kebun Rakyat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Nav -->
  <nav class="fixed top-0 left-0 right-0 z-50 bg-white shadow-md">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16 sm:h-20">
        <div class="flex items-center gap-2 sm:gap-3">
          <div class="w-9 h-9 sm:w-11 sm:h-11 bg-gradient-to-br from-green-600 to-green-400 rounded-xl flex items-center justify-center text-lg sm:text-xl">ðŸŒ±</div>
          <div>
            <div class="font-bold text-sm sm:text-base text-green-600" style="font-family: Georgia, serif;">Kebun Rakyat</div>
            <div class="text-xs text-gray-400 font-semibold">Ministry Analytics Dashboard</div>
          </div>
        </div>
        <button onclick="signOut()" class="px-4 py-2 border-2 border-gray-200 text-gray-600 font-semibold text-sm rounded-full hover:border-red-300 hover:text-red-500 transition-all">Sign Out</button>
      </div>
    </div>
  </nav>

  <div class="pt-16 sm:pt-20 container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-10">

    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 sm:mb-8" style="font-family: Georgia, serif;">Ministry Analytics</h1>

    <!-- Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-5 mb-8 sm:mb-10">
      <div class="bg-white rounded-2xl p-4 sm:p-6 shadow-md text-center">
        <div class="text-2xl sm:text-3xl lg:text-4xl font-bold text-green-600" id="totalUsers">â€”</div>
        <div class="text-gray-500 text-sm sm:text-base mt-1">Total Users</div>
      </div>
      <div class="bg-white rounded-2xl p-4 sm:p-6 shadow-md text-center">
        <div class="text-2xl sm:text-3xl lg:text-4xl font-bold text-amber-500" id="totalFarmers">â€”</div>
        <div class="text-gray-500 text-sm sm:text-base mt-1">Farmers</div>
      </div>
      <div class="bg-white rounded-2xl p-4 sm:p-6 shadow-md text-center">
        <div class="text-2xl sm:text-3xl lg:text-4xl font-bold text-blue-500" id="totalProducts">â€”</div>
        <div class="text-gray-500 text-sm sm:text-base mt-1">Products</div>
      </div>
      <div class="bg-white rounded-2xl p-4 sm:p-6 shadow-md text-center">
        <div class="text-2xl sm:text-3xl lg:text-4xl font-bold text-purple-500" id="totalOrders">â€”</div>
        <div class="text-gray-500 text-sm sm:text-base mt-1">Orders</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 sm:gap-3 mb-6 flex-wrap">
      <button onclick="showTab('users')" class="tab-btn px-4 sm:px-5 py-2 sm:py-2.5 rounded-full font-semibold text-sm sm:text-base bg-green-600 text-white transition-all" data-tab="users">Users</button>
      <button onclick="showTab('products')" class="tab-btn px-4 sm:px-5 py-2 sm:py-2.5 rounded-full font-semibold text-sm sm:text-base bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tab="products">Products</button>
      <button onclick="showTab('orders')" class="tab-btn px-4 sm:px-5 py-2 sm:py-2.5 rounded-full font-semibold text-sm sm:text-base bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tab="orders">Orders</button>
    </div>

    <!-- Tables -->
    <div class="bg-white rounded-2xl shadow-md overflow-hidden">

      <!-- Users Table -->
      <div id="tab-users">
        <div class="p-5 sm:p-6 border-b"><h2 class="font-bold text-gray-800 text-base sm:text-lg">All Users</h2></div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm sm:text-base" style="min-width: 500px;">
            <thead class="bg-gray-50 text-gray-500 text-xs sm:text-sm font-semibold">
              <tr><th class="px-4 sm:px-6 py-3 text-left">Email</th><th class="px-4 sm:px-6 py-3 text-left">Role</th><th class="px-4 sm:px-6 py-3 text-left">Farm Name</th><th class="px-4 sm:px-6 py-3 text-left">Joined</th></tr>
            </thead>
            <tbody id="usersBody" class="divide-y divide-gray-100"><tr><td colspan="4" class="text-center py-8 text-gray-400">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Products Table -->
      <div id="tab-products" class="hidden">
        <div class="p-5 sm:p-6 border-b"><h2 class="font-bold text-gray-800 text-base sm:text-lg">All Products</h2></div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm sm:text-base" style="min-width: 500px;">
            <thead class="bg-gray-50 text-gray-500 text-xs sm:text-sm font-semibold">
              <tr><th class="px-4 sm:px-6 py-3 text-left">Product</th><th class="px-4 sm:px-6 py-3 text-left">Farmer</th><th class="px-4 sm:px-6 py-3 text-left">Price</th><th class="px-4 sm:px-6 py-3 text-left">Location</th></tr>
            </thead>
            <tbody id="productsBody" class="divide-y divide-gray-100"><tr><td colspan="4" class="text-center py-8 text-gray-400">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Orders Table -->
      <div id="tab-orders" class="hidden">
        <div class="p-5 sm:p-6 border-b"><h2 class="font-bold text-gray-800 text-base sm:text-lg">All Orders</h2></div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm sm:text-base" style="min-width: 600px;">
            <thead class="bg-gray-50 text-gray-500 text-xs sm:text-sm font-semibold">
              <tr><th class="px-4 sm:px-6 py-3 text-left">Order #</th><th class="px-4 sm:px-6 py-3 text-left">Customer</th><th class="px-4 sm:px-6 py-3 text-left">Total</th><th class="px-4 sm:px-6 py-3 text-left">Status</th><th class="px-4 sm:px-6 py-3 text-left">Date</th></tr>
            </thead>
            <tbody id="ordersBody" class="divide-y divide-gray-100"><tr><td colspan="5" class="text-center py-8 text-gray-400">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged, signOut as fbSignOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    onAuthStateChanged(auth, async user => {
      if (!user) { window.location.href = 'login.html'; return; }
      const ud = await getDoc(doc(db, 'users', user.uid));
      if (!ud.exists() || ud.data().role !== 'admin') { window.location.href = 'marketplace.html'; return; }
      loadAll();
    });

    async function loadAll() {
      const [users, products, orders] = await Promise.all([
        getDocs(collection(db, 'users')),
        getDocs(collection(db, 'products')),
        getDocs(collection(db, 'orders'))
      ]);

      const uList = users.docs.map(d => d.data());
      const pList = products.docs.map(d => d.data());
      const oList = orders.docs.map(d => d.data());

      document.getElementById('totalUsers').textContent = uList.length;
      document.getElementById('totalFarmers').textContent = uList.filter(u => u.role === 'farmer').length;
      document.getElementById('totalProducts').textContent = pList.length;
      document.getElementById('totalOrders').textContent = oList.length;

      document.getElementById('usersBody').innerHTML = uList.map(u => `
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-700">${u.email}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4"><span class="px-2 py-1 rounded-full text-xs font-semibold ${u.role === 'farmer' ? 'bg-green-100 text-green-700' : u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600'}">${u.role}</span></td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-500">${u.farmName || 'â€”'}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-400 text-xs sm:text-sm">${u.createdAt?.toDate?.()?.toLocaleDateString() || 'â€”'}</td>
        </tr>`).join('');

      document.getElementById('productsBody').innerHTML = pList.map(p => `
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-4 sm:px-6 py-3 sm:py-4"><span class="mr-2">${p.emoji || 'ðŸŒ¾'}</span>${p.name}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-500">${p.farmerName}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 font-semibold text-green-600">RM ${p.price.toFixed(2)}/kg</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-500">${p.location}</td>
        </tr>`).join('');

      document.getElementById('ordersBody').innerHTML = oList.map(o => `
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-4 sm:px-6 py-3 sm:py-4 font-mono text-xs sm:text-sm text-gray-600">${o.orderNumber}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4"><div class="font-semibold text-gray-700">${o.customerName}</div><div class="text-gray-400 text-xs">${o.customerEmail}</div></td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 font-bold text-green-600">RM ${o.total.toFixed(2)}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4"><span class="px-2 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700 capitalize">${o.status}</span></td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-gray-400 text-xs sm:text-sm">${o.createdAt?.toDate?.()?.toLocaleDateString() || 'â€”'}</td>
        </tr>`).join('');
    }

    window.signOut = () => fbSignOut(auth).then(() => window.location.href = 'login.html');
  </script>
  <script>
    function showTab(tab) {
      ['users','products','orders'].forEach(t => {
        document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab);
        const btn = document.querySelector(`[data-tab="${t}"]`);
        if (t === tab) { btn.className = 'tab-btn px-4 sm:px-5 py-2 sm:py-2.5 rounded-full font-semibold text-sm sm:text-base bg-green-600 text-white transition-all'; }
        else { btn.className = 'tab-btn px-4 sm:px-5 py-2 sm:py-2.5 rounded-full font-semibold text-sm sm:text-base bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all'; }
      });
    }
  </script>
</body>
</html>