<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketplace - Kebun Rakyat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background: linear-gradient(to bottom right, #fef3c7, #ffffff, #d1fae5); min-height: 100vh; }
    
    /* Navigation - Mobile First */
    nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 12px 16px; position: sticky; top: 0; z-index: 100; }
    .nav-content { max-width: 1280px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .logo { display: flex; align-items: center; gap: 8px; text-decoration: none; }
    .logo-icon { width: 40px; height: 40px; background: linear-gradient(to bottom right, #16a34a, #10b981); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .logo-text h1 { font-size: 16px; font-weight: 700; background: linear-gradient(to right, #15803d, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-family: Georgia, serif; }
    .logo-text p { font-size: 7px; color: #16a34a; font-weight: 600; letter-spacing: 1.2px; }
    .nav-links { display: none; }
    .btn-cart { padding: 10px 18px; border-radius: 24px; background: linear-gradient(to right, #16a34a, #10b981); color: white; text-decoration: none; font-weight: 600; font-size: 15px; position: relative; display: flex; align-items: center; gap: 6px; min-height: 44px; }
    .cart-badge { position: absolute; top: -6px; right: -6px; background: #dc2626; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    
    /* Hero Banner */
    .hero-banner { background: linear-gradient(135deg, #16a34a 0%, #10b981 100%); padding: 28px 16px; color: white; }
    .hero-content { max-width: 1280px; margin: 0 auto; }
    .hero-badge { display: inline-block; background: rgba(255, 255, 255, 0.25); padding: 8px 14px; border-radius: 24px; font-size: 13px; font-weight: 600; margin-bottom: 14px; }
    .hero-banner h1 { font-size: 30px; font-weight: 700; margin-bottom: 10px; font-family: Georgia, serif; line-height: 1.2; }
    .hero-banner p { font-size: 15px; opacity: 0.95; line-height: 1.5; }
    
    /* Container */
    .container { max-width: 1280px; margin: 0 auto; padding: 20px 16px 40px; }
    
    /* Search Bar */
    .search-section { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); margin-bottom: 16px; }
    .search-bar { position: relative; margin-bottom: 14px; }
    .search-bar input { width: 100%; padding: 16px 16px 16px 48px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; outline: none; }
    .search-bar input:focus { border-color: #16a34a; }
    .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 22px; }
    
    /* Filter Chips */
    .filter-chips { display: flex; gap: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; }
    .filter-chips::-webkit-scrollbar { display: none; }
    .filter-chip { padding: 10px 18px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; font-size: 15px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.2s; min-height: 44px; display: inline-flex; align-items: center; }
    .filter-chip.active { background: #16a34a; color: white; border-color: #16a34a; }
    
    /* Sort Section */
    .sort-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; }
    .result-count { font-size: 17px; font-weight: 700; color: #111827; }
    .sort-dropdown { padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; font-weight: 600; background: white; outline: none; cursor: pointer; min-height: 44px; }
    
    /* Products Grid - Mobile First (1 column) */
    .products-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    
    /* Product Card - Spacious Mobile Design */
    .product-card { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); transition: all 0.3s; }
    .product-card:active { transform: scale(0.98); }
    .product-card a { display: block; text-decoration: none; color: inherit; }
    
    .product-image { background: linear-gradient(135deg, #fef3c7 0%, #d1fae5 100%); padding: 40px; text-align: center; font-size: 100px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
    
    .product-info { padding: 20px; }
    .product-name { font-size: 20px; font-weight: 700; color: #111827; margin-bottom: 8px; line-height: 1.3; }
    .product-farmer { font-size: 15px; color: #6b7280; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    
    .product-meta { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
    .meta-tag { padding: 6px 12px; background: #dcfce7; color: #15803d; border-radius: 8px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    
    .product-rating { display: flex; align-items: center; gap: 8px; font-size: 15px; margin-bottom: 12px; font-weight: 600; }
    .product-location { font-size: 14px; color: #6b7280; margin-bottom: 16px; }
    
    .product-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 14px; border-top: 2px solid #f3f4f6; }
    .product-price-section { flex: 1; }
    .product-price { font-size: 28px; font-weight: 700; color: #16a34a; line-height: 1.1; }
    .product-unit { font-size: 14px; color: #6b7280; margin-top: 2px; }
    
    .btn-add-cart { padding: 14px 24px; background: linear-gradient(to right, #16a34a, #10b981); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 8px; min-height: 48px; width: 100%; justify-content: center; }
    .btn-add-cart:active { transform: scale(0.96); }
    
    /* Empty State */
    .empty-state { text-align: center; padding: 80px 20px; }
    .empty-icon { font-size: 72px; margin-bottom: 20px; }
    .empty-state h3 { font-size: 22px; color: #111827; margin-bottom: 10px; font-weight: 700; }
    .empty-state p { font-size: 16px; color: #6b7280; line-height: 1.5; }
    
    /* Loading */
    .loading { text-align: center; padding: 60px 20px; color: #6b7280; font-size: 16px; }
    
    /* Footer */
    footer { background: #111827; color: white; padding: 40px 16px; text-align: center; margin-top: 60px; }
    .footer-logo { display: inline-flex; align-items: center; gap: 10px; margin-bottom: 16px; }
    .footer-logo h3 { font-size: 22px; font-family: Georgia, serif; }
    
    /* Notification */
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Tablet - 2 columns (640px+) */
    @media (min-width: 640px) {
      .products-grid { grid-template-columns: repeat(2, 1fr); gap: 24px; }
      .product-image { font-size: 120px; min-height: 220px; }
      .hero-banner h1 { font-size: 40px; }
      .hero-banner p { font-size: 17px; }
      .hero-banner { padding: 36px 20px; }
      .container { padding: 28px 20px 50px; }
    }
    
    /* Desktop - 3 columns (1024px+) */
    @media (min-width: 1024px) {
      nav { padding: 16px 24px; }
      .logo-icon { width: 48px; height: 48px; font-size: 24px; }
      .logo-text h1 { font-size: 24px; }
      .logo-text p { font-size: 10px; letter-spacing: 2px; }
      .nav-links { display: flex; gap: 28px; align-items: center; }
      .nav-links a { color: #374151; text-decoration: none; font-weight: 500; font-size: 15px; transition: color 0.2s; }
      .nav-links a:hover { color: #16a34a; }
      
      .hero-banner { padding: 56px 24px; }
      .hero-banner h1 { font-size: 52px; }
      .hero-banner p { font-size: 20px; }
      
      .container { padding: 40px 24px 80px; }
      .products-grid { grid-template-columns: repeat(3, 1fr); gap: 28px; }
      .search-section { padding: 24px; }
      .filter-chips { gap: 14px; }
      .product-image { font-size: 140px; }
    }
    
    /* Large Desktop - 4 columns (1280px+) */
    @media (min-width: 1280px) {
      .products-grid { grid-template-columns: repeat(4, 1fr); gap: 32px; }
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-content">
      <a href="index.html" class="logo">
        <div class="logo-icon">üå±</div>
        <div class="logo-text"><h1>Kebun Rakyat</h1><p>PASARAN PETANI</p></div>
      </a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="marketplace.html">Marketplace</a>
        <a href="about.html">About Us</a>
      </div>
      <a href="cart.html" class="btn-cart">
        üõí <span class="cart-badge" id="cartCount">0</span>
      </a>
    </div>
  </nav>

  <div class="hero-banner">
    <div class="hero-content">
      <div class="hero-badge">üåæ Fresh from Malaysian Farms</div>
      <h1>Fresh Harvests, Direct from Farm</h1>
      <p>Browse quality produce from verified farmers across Malaysia</p>
    </div>
  </div>

  <div class="container">
    <!-- Search & Filter Section -->
    <div class="search-section">
      <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" placeholder="Search products, farms, or locations..." />
      </div>
      
      <div class="filter-chips">
        <button class="filter-chip active" data-filter="all">All</button>
        <button class="filter-chip" data-filter="ready">Ready Now</button>
        <button class="filter-chip" data-filter="vegetables">Vegetables</button>
        <button class="filter-chip" data-filter="fruits">Fruits</button>
        <button class="filter-chip" data-filter="grains">Grains</button>
      </div>
    </div>

    <!-- Sort & Count -->
    <div class="sort-section">
      <div class="result-count" id="resultCount">Loading...</div>
      <select class="sort-dropdown" id="sortSelect">
        <option value="newest">Newest</option>
        <option value="price-low">Price ‚Üë</option>
        <option value="price-high">Price ‚Üì</option>
        <option value="rating">Top Rated</option>
        <option value="name">A-Z</option>
      </select>
    </div>

    <!-- Products Grid -->
    <div class="products-grid" id="productsList">
      <div class="loading">Loading products...</div>
    </div>
  </div>

  <footer>
    <div class="footer-logo">
      <div class="logo-icon">üå±</div>
      <h3>Kebun Rakyat</h3>
    </div>
    <p style="color: #9ca3af; font-size: 15px;">Menghubungkan petani dan pembeli untuk masa depan yang lestari</p>
  </footer>

  <script type="module">
    import { db } from './firebase-config.js';
    import { collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let allProducts = [];
    let filteredProducts = [];

    // Update cart count
    function updateCartCount() {
      const grouped = {};
      cart.forEach(item => {
        grouped[item.id] = (grouped[item.id] || 0) + 1;
      });
      document.getElementById('cartCount').textContent = Object.keys(grouped).length;
    }

    // Categorize products
    function categorizeProduct(name) {
      const vegetables = ['tomato', 'lettuce', 'cabbage', 'carrot', 'cucumber', 'pepper', 'chili'];
      const fruits = ['apple', 'banana', 'strawberry', 'watermelon', 'papaya', 'orange'];
      const grains = ['rice', 'corn', 'wheat'];
      
      const nameLower = name.toLowerCase();
      if (vegetables.some(v => nameLower.includes(v))) return 'vegetables';
      if (fruits.some(f => nameLower.includes(f))) return 'fruits';
      if (grains.some(g => nameLower.includes(g))) return 'grains';
      return 'other';
    }

    // Load products
    async function loadProducts() {
      try {
        const querySnapshot = await getDocs(collection(db, 'products'));
        allProducts = [];
        
        querySnapshot.forEach((doc) => {
          const product = doc.data();
          allProducts.push({
            id: doc.id,
            ...product,
            category: categorizeProduct(product.name),
            rating: product.rating || (4 + Math.random())
          });
        });

        filteredProducts = [...allProducts];
        sortAndDisplay();
        updateCartCount();
      } catch (error) {
        document.getElementById('productsList').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <h3>Error Loading Products</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      applyFilters(searchTerm);
    });

    // Filter chips
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        applyFilters(searchTerm);
      });
    });

    // Apply filters
    function applyFilters(searchTerm = '') {
      const activeFilter = document.querySelector('.filter-chip.active').dataset.filter;
      
      filteredProducts = allProducts.filter(product => {
        // Search filter
        const matchesSearch = searchTerm === '' || 
          product.name.toLowerCase().includes(searchTerm) ||
          product.location.toLowerCase().includes(searchTerm) ||
          product.farmerName.toLowerCase().includes(searchTerm);
        
        // Category filter
        let matchesFilter = true;
        if (activeFilter === 'ready') {
          matchesFilter = product.harvestTime.toLowerCase().includes('ready');
        } else if (activeFilter !== 'all') {
          matchesFilter = product.category === activeFilter;
        }
        
        return matchesSearch && matchesFilter;
      });
      
      sortAndDisplay();
    }

    // Sort dropdown
    document.getElementById('sortSelect').addEventListener('change', sortAndDisplay);

    // Sort and display
    function sortAndDisplay() {
      const sortValue = document.getElementById('sortSelect').value;
      
      let sorted = [...filteredProducts];
      
      switch(sortValue) {
        case 'price-low':
          sorted.sort((a, b) => a.price - b.price);
          break;
        case 'price-high':
          sorted.sort((a, b) => b.price - a.price);
          break;
        case 'rating':
          sorted.sort((a, b) => b.rating - a.rating);
          break;
        case 'name':
          sorted.sort((a, b) => a.name.localeCompare(b.name));
          break;
        case 'newest':
        default:
          sorted.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      }
      
      displayProducts(sorted);
    }

    // Display products
    function displayProducts(products) {
      const productsList = document.getElementById('productsList');
      
      // Update count
      document.getElementById('resultCount').textContent = 
        `${products.length} Product${products.length !== 1 ? 's' : ''}`;
      
      if (products.length === 0) {
        productsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <h3>No Products Found</h3>
            <p>Try adjusting your search or filters</p>
          </div>
        `;
        return;
      }
      
      productsList.innerHTML = products.map(product => `
        <div class="product-card">
          <a href="product.html?id=${product.id}">
            <div class="product-image">${product.emoji || 'üåæ'}</div>
            <div class="product-info">
              <h3 class="product-name">${product.name}</h3>
              <p class="product-farmer">üå± ${product.farmerName}</p>
              
              <div class="product-meta">
                <span class="meta-tag">‚è∞ ${product.harvestTime}</span>
              </div>
              
              <div class="product-rating">‚≠ê ${product.rating.toFixed(1)} <span style="color: #9ca3af; font-weight: 500;">(${Math.floor(Math.random() * 200 + 50)})</span></div>
              
              <p class="product-location">üìç ${product.location}</p>
              
              <div class="product-footer">
                <div class="product-price-section">
                  <div class="product-price">RM ${product.price.toFixed(2)}</div>
                  <div class="product-unit">per kg</div>
                </div>
              </div>
            </div>
          </a>
          <div style="padding: 0 20px 20px;">
            <button class="btn-add-cart" onclick="event.stopPropagation(); addToCart('${product.id}', '${product.name}', ${product.price}, '${product.emoji}')">
              üõí Add to Cart
            </button>
          </div>
        </div>
      `).join('');
    }

    // Add to cart with notification
    window.addToCart = (id, name, price, emoji) => {
      cart.push({ id, name, price, emoji });
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      
      const notification = document.createElement('div');
      notification.style.cssText = 'position: fixed; top: 90px; right: 16px; background: white; padding: 18px 20px; border-radius: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 1000; animation: slideIn 0.3s; max-width: calc(100vw - 32px);';
      notification.innerHTML = `<strong style="font-size: 17px;">${emoji} ${name}</strong><br><span style="color: #6b7280; font-size: 15px;">Added to cart</span>`;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.remove(), 2500);
    };

    loadProducts();
  </script>
</body>
</html>